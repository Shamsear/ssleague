# Player Data Architecture

## Overview
Player data is now split into two Firestore collections for better data organization and to prevent data overwriting across seasons.

## Collections

### 1. `realplayers` Collection
**Purpose:** Stores permanent player information that doesn't change across seasons.

**Document Structure:**
- **Document ID:** `player_id` (e.g., "sspslpsl0015")
- **Fields:**
  ```typescript
  {
    player_id: string;        // Unique player identifier
    name: string;             // Player's full name
    display_name?: string;    // Nickname or preferred name
    email?: string;           // Email address
    phone?: string;           // Phone number
    role?: string;            // player | captain | vice_captain
    psn_id?: string;          // PlayStation Network ID
    xbox_id?: string;         // Xbox ID
    steam_id?: string;        // Steam ID
    is_registered: boolean;   // Registration status
    is_active: boolean;       // Active status
    is_available: boolean;    // Available for matches
    notes?: string;           // Admin notes
    created_at: Timestamp;    // When player was created
    updated_at: Timestamp;    // Last update
    joined_date: Timestamp;   // When player joined
  }
  ```

**Key Points:**
- One document per player (unique by `player_id`)
- Contains only permanent/biographical information
- Never stores season-specific data (category, team, stats)

### 2. `realplayerstats` Collection
**Purpose:** Stores season-specific statistics, team assignments, and categories.

**Document Structure:**
- **Document ID:** Auto-generated by Firestore
- **Fields:**
  ```typescript
  {
    player_id: string;        // Reference to realplayers document
    player_name: string;      // Player name (for easy querying)
    season_id: string;        // Reference to seasons document
    season_name?: string;     // Cached season name
    
    // Season-specific assignments
    team: string;             // Team name for this season
    team_id?: string;         // Reference to teams document
    category: string;         // Category for this season (RED, BLACK, BLUE, etc.)
    
    // Season statistics
    stats: {
      matches_played: number;
      matches_won: number;
      matches_lost: number;
      matches_drawn: number;
      goals_scored: number;
      goals_per_game: number;
      goals_conceded: number;
      conceded_per_game: number;
      net_goals: number;
      assists: number;
      clean_sheets: number;
      points: number;
      total_points: number;
      win_rate: number;
      average_rating: number;
      current_season_matches: number;
      current_season_wins: number;
    };
    
    created_at: Timestamp;
    updated_at: Timestamp;
  }
  ```

**Key Points:**
- Multiple documents per player (one per season)
- Each document represents one player in one season
- Contains all season-specific data
- Uniquely identified by combination of (`player_id` + `season_id`)

## Data Flow

### Creating/Updating Historical Seasons

When importing a historical season:

1. **Update `realplayers`:**
   - Check if player document exists (by `player_id`)
   - If exists: Update only permanent fields (email, phone, etc.)
   - If new: Create new document with `player_id` as document ID

2. **Update `realplayerstats`:**
   - Query for existing document where (`player_id` == player && `season_id` == season)
   - If exists: Update the stats document
   - If new: Create new document with auto-generated ID
   - Store season-specific: category, team, team_id, stats

### Querying Player Data

To display a player's information:

1. **Fetch permanent data:**
   ```typescript
   const playerDoc = await getDoc(doc(db, 'realplayers', playerId));
   const permanentData = playerDoc.data();
   ```

2. **Fetch all season stats:**
   ```typescript
   const statsQuery = query(
     collection(db, 'realplayerstats'),
     where('player_id', '==', playerId)
   );
   const statsSnapshot = await getDocs(statsQuery);
   ```

3. **Combine the data:**
   ```typescript
   const allSeasons = statsSnapshot.docs.map(doc => ({
     ...permanentData,     // name, email, phone, etc.
     ...doc.data()         // category, team, stats (season-specific)
   }));
   ```

## Benefits of This Architecture

### 1. **Data Integrity**
- Permanent data is never overwritten when adding new seasons
- Each season's data is isolated in its own document

### 2. **Flexibility**
- Player can have different categories in different seasons
- Player can play for different teams in different seasons
- Easy to query all seasons for a player or specific season stats

### 3. **Performance**
- Efficient queries (no need to scan all documents for one player)
- Indexed by `player_id` and `season_id` for fast lookups

### 4. **Scalability**
- Can easily add new seasons without affecting existing data
- Simple to archive old seasons without touching permanent player data

## Example Data

### realplayers Document
```json
{
  "player_id": "sspslpsl0015",
  "name": "SHAMEEM H",
  "display_name": "",
  "email": "",
  "phone": "",
  "psn_id": "",
  "role": "player",
  "is_registered": false,
  "is_active": true,
  "is_available": true,
  "notes": "",
  "created_at": "2025-10-13T...",
  "updated_at": "2025-10-13T...",
  "joined_date": "2025-10-13T..."
}
```

### realplayerstats Documents (Multiple per player)

**Season 13:**
```json
{
  "player_id": "sspslpsl0015",
  "player_name": "SHAMEEM H",
  "season_id": "season-13-id",
  "season_name": "Season 13",
  "team": "PORTLAND TIMBERS",
  "team_id": "team-123",
  "category": "RED",
  "stats": {
    "matches_played": 30,
    "goals_scored": 42,
    ...
  },
  "created_at": "2025-10-13T...",
  "updated_at": "2025-10-13T..."
}
```

**Season 14:**
```json
{
  "player_id": "sspslpsl0015",
  "player_name": "SHAMEEM H",
  "season_id": "season-14-id",
  "season_name": "Season 14",
  "team": "CHELSEA FC",
  "team_id": "team-456",
  "category": "WHITE",
  "stats": {
    "matches_played": 35,
    "goals_scored": 49,
    ...
  },
  "created_at": "2025-10-13T...",
  "updated_at": "2025-10-13T..."
}
```

## Migration Notes

When migrating from the old single-collection structure:

1. Existing data in `realplayers` should be split:
   - Keep permanent fields in `realplayers`
   - Move season-specific data to `realplayerstats`

2. Each old player document becomes:
   - One document in `realplayers` (permanent data)
   - One document in `realplayerstats` per season

3. No data loss - just reorganization for better structure
