# Players System - RealPlayers & FootballPlayers

This document explains the complete player management system with custom ID generation, stats tracking, and team associations.

## Overview

The system manages **two distinct types of players**:

### 1. **RealPlayers** (Human eFootball Players)
- **Purpose**: Real people who actually play the eFootball video game
- **Team Size**: 4-6+ members per team
- **Custom ID Format**: `sspslpsl0001`, `sspslpsl0002`, etc.
- **Management**: Assigned by committee admins
- **Example**: John (sspslpsl0001) is a real person who plays eFootball for "Manchester United"

### 2. **FootballPlayers** (Virtual In-Game Squad)
- **Purpose**: Virtual football players (like Ronaldo, Messi) used in eFootball matches
- **Team Size**: 23-25+ players per team (like a real football squad)
- **ID Format**: Firestore auto-generated
- **Management**: Acquired through auction system
- **Example**: Cristiano Ronaldo (virtual card) bought by "Manchester United" in auction

### 3. **Teams** (Updated Structure)
- **Custom ID Format**: `team0001`, `team0002`, etc.
- **Contains**: Both RealPlayers and FootballPlayers
- **Stats Tracking**: Match performance, goals, points, league position
- **Financial**: Balance, total spent on players

---

## Firebase Collections

### Collection: `realplayers`

```typescript
{
  player_id: "sspslpsl0001",  // Custom ID (document ID)
  full_name: "John Doe",
  display_name: "Johnny",      // Optional nickname
  email: "john@example.com",
  phone: "+1234567890",
  
  // Team Assignment
  team_id: "team0001",         // Reference to team document
  team_name: "Manchester United",
  team_code: "MUN",
  
  // Season
  season_id: "seasonDocId",
  season_name: "Season 2024",
  
  // Role
  role: "captain",             // captain | vice_captain | player
  
  // Status
  is_active: true,
  is_available: true,          // Available for matches
  
  // Statistics
  stats: {
    matches_played: 25,
    matches_won: 18,
    matches_lost: 5,
    matches_drawn: 2,
    goals_scored: 45,
    assists: 23,
    clean_sheets: 12,
    win_rate: 72.0,            // Auto-calculated
    average_rating: 8.5,
    current_season_matches: 25,
    current_season_wins: 18
  },
  
  // Gaming Platform IDs
  psn_id: "john_psn",          // PlayStation Network
  xbox_id: "john_xbox",        // Xbox
  steam_id: "john_steam",      // Steam
  
  profile_image: "base64...",  // Optional
  joined_date: Timestamp,
  assigned_by: "adminUid",     // Who assigned this player
  notes: "Team captain",
  
  created_at: Timestamp,
  updated_at: Timestamp
}
```

### Collection: `footballplayers`

```typescript
{
  // Document ID: Auto-generated by Firestore
  
  // Basic Info
  name: "Cristiano Ronaldo",
  full_name: "Cristiano Ronaldo dos Santos Aveiro",
  age: 39,
  nationality: "Portugal",
  
  // Position & Attributes
  primary_position: "CF",      // Center Forward
  secondary_positions: ["LWF", "RWF", "SS"],
  preferred_foot: "Right",
  attributes: {
    overall_rating: 91,
    pace: 89,
    shooting: 93,
    passing: 82,
    dribbling: 89,
    defending: 35,
    physical: 77
  },
  
  // Team Assignment (after auction)
  team_id: "team0001",
  team_name: "Manchester United",
  team_code: "MUN",
  
  // Auction Info
  base_price: 5000000,
  sold_price: 8500000,
  is_sold: true,
  auction_round: 1,
  
  // Season
  season_id: "seasonDocId",
  season_name: "Season 2024",
  
  // Status
  is_available: true,
  is_injured: false,
  injury_details: null,
  suspension_matches: 0,
  
  // Card Type
  player_image: "base64...",
  card_type: "Legend",         // Gold | Silver | Bronze | Legend | Featured
  
  // Match Stats
  matches_played: 20,
  goals: 35,
  assists: 12,
  yellow_cards: 2,
  red_cards: 0,
  clean_sheets: 0,
  
  added_by: "adminUid",
  notes: "Star striker",
  
  created_at: Timestamp,
  updated_at: Timestamp
}
```

### Collection: `teams` (Updated)

```typescript
{
  team_id: "team0001",         // Custom ID (document ID)
  team_name: "Manchester United",
  team_code: "MUN",
  
  owner_uid: "userDocId",
  owner_name: "Team Owner",
  owner_email: "owner@example.com",
  
  // Financial
  balance: 15000000,
  initial_balance: 25000000,
  total_spent: 10000000,
  
  // Season
  season_id: "seasonDocId",
  season_name: "Season 2024",
  
  // Players Arrays
  real_players: ["sspslpsl0001", "sspslpsl0002", "sspslpsl0003"],
  football_players: ["fpDocId1", "fpDocId2", ... "fpDocId25"],
  real_players_count: 5,
  football_players_count: 25,
  
  // Team Statistics
  stats: {
    matches_played: 20,
    matches_won: 15,
    matches_lost: 3,
    matches_drawn: 2,
    points: 47,                // Win=3, Draw=1, Loss=0
    goals_scored: 55,
    goals_conceded: 18,
    goal_difference: 37,       // Auto-calculated
    clean_sheets: 8,
    win_rate: 75.0,            // Auto-calculated
    current_position: 2,       // League table position
    highest_position: 1,
    lowest_position: 3
  },
  
  is_active: true,
  logo: "base64...",
  team_color: "#FF0000",
  
  created_at: Timestamp,
  updated_at: Timestamp
}
```

---

## Custom ID Generation

### RealPlayer IDs: `sspslpsl0001`

**Format**: `sspslpsl` + 4-digit padded number

**Generation Logic**:
```typescript
// Scans all existing realplayers
// Finds highest number (e.g., sspslpsl0005)
// Generates next ID (e.g., sspslpsl0006)
```

**Examples**:
- First player: `sspslpsl0001`
- Second player: `sspslpsl0002`
- 100th player: `sspslpsl0100`

### Team IDs: `team0001`

**Format**: `team` + 4-digit padded number

**Generation Logic**:
```typescript
// Scans all existing teams
// Finds highest number (e.g., team0015)
// Generates next ID (e.g., team0016)
```

**Examples**:
- First team: `team0001`
- Second team: `team0002`
- 50th team: `team0050`

---

## Files Structure

### Type Definitions

1. **`types/realPlayer.ts`** - RealPlayer interfaces
   - `RealPlayerData` - Complete player object
   - `RealPlayerStats` - Statistics interface
   - `CreateRealPlayerData` - Creation payload
   - `UpdateRealPlayerData` - Update payload
   - `UpdateRealPlayerStatsData` - Stats update payload

2. **`types/footballPlayer.ts`** - FootballPlayer interfaces
   - `FootballPlayerData` - Complete player object
   - `FootballPlayerAttributes` - Attributes (pace, shooting, etc.)
   - `CreateFootballPlayerData` - Creation payload
   - `UpdateFootballPlayerData` - Update payload
   - `AssignFootballPlayerToTeamData` - Auction assignment
   - `UpdateFootballPlayerStatsData` - Stats update payload
   - `PlayerPosition` - Position types (GK, CB, CF, etc.)

3. **`types/team.ts`** - Updated team interfaces
   - `TeamData` - Complete team object with custom ID
   - `TeamStats` - Team statistics interface
   - `CreateTeamData` - Creation payload
   - `UpdateTeamData` - Update payload
   - `UpdateTeamStatsData` - Stats update payload

### Firebase Libraries

1. **`lib/firebase/realPlayers.ts`** - RealPlayer operations
   - `generatePlayerId()` - Custom ID generation
   - `getAllRealPlayers()` - Get all players
   - `getRealPlayersByTeam()` - Get by team
   - `getRealPlayersBySeason()` - Get by season
   - `getRealPlayerById()` - Get single player
   - `createRealPlayer()` - Create with auto team assignment
   - `updateRealPlayer()` - Update with team reassignment logic
   - `updateRealPlayerStats()` - Update stats with auto-calc
   - `deleteRealPlayer()` - Delete with team cleanup
   - `getRealPlayerStatistics()` - Get summary stats

2. **`lib/firebase/footballPlayers.ts`** - FootballPlayer operations
   - `getAllFootballPlayers()` - Get all players
   - `getFootballPlayersByTeam()` - Get by team
   - `getFootballPlayersBySeason()` - Get by season
   - `getAvailableFootballPlayers()` - Get unsold players
   - `getFootballPlayerById()` - Get single player
   - `createFootballPlayer()` - Create new player
   - `updateFootballPlayer()` - Update player
   - `assignFootballPlayerToTeam()` - Auction purchase logic
   - `releaseFootballPlayerFromTeam()` - Remove from team
   - `updateFootballPlayerStats()` - Update match stats
   - `deleteFootballPlayer()` - Delete with cleanup
   - `getFootballPlayerStatistics()` - Get summary stats
   - `bulkCreateFootballPlayers()` - Import multiple players

3. **`lib/firebase/teams.ts`** - Updated team operations
   - `generateTeamId()` - Custom team ID generation
   - `initializeTeamStats()` - Initialize empty stats
   - `createTeam()` - Create with custom ID and stats
   - `updateTeamStats()` - Update stats with auto-calculations
   - All other existing team functions

---

## Usage Examples

### Creating a RealPlayer

```typescript
import { createRealPlayer } from '@/lib/firebase/realPlayers';

const newPlayer = await createRealPlayer({
  full_name: 'John Doe',
  display_name: 'Johnny',
  email: 'john@example.com',
  team_id: 'team0001',        // Optional
  season_id: 'seasonDocId',
  role: 'captain',
  psn_id: 'john_psn',
}, 'adminUserId');

// Result: Player with ID sspslpsl0001 created
// Team's real_players array automatically updated
```

### Creating FootballPlayers

```typescript
import { createFootballPlayer } from '@/lib/firebase/footballPlayers';

const ronaldo = await createFootballPlayer({
  name: 'C. Ronaldo',
  full_name: 'Cristiano Ronaldo',
  age: 39,
  nationality: 'Portugal',
  primary_position: 'CF',
  secondary_positions: ['LWF', 'SS'],
  preferred_foot: 'Right',
  attributes: {
    overall_rating: 91,
    pace: 89,
    shooting: 93,
    passing: 82,
    dribbling: 89,
    defending: 35,
    physical: 77
  },
  base_price: 5000000,
  season_id: 'seasonDocId',
  card_type: 'Legend',
}, 'adminUserId');
```

### Assigning FootballPlayer to Team (Auction)

```typescript
import { assignFootballPlayerToTeam } from '@/lib/firebase/footballPlayers';

await assignFootballPlayerToTeam({
  player_id: 'footballPlayerDocId',
  team_id: 'team0001',
  sold_price: 8500000,
  auction_round: 1,
});

// Automatically:
// - Updates player with team info
// - Adds player to team's football_players array
// - Deducts sold_price from team balance
// - Increases team's total_spent
```

### Creating a Team

```typescript
import { createTeam } from '@/lib/firebase/teams';

const newTeam = await createTeam({
  team_name: 'Manchester United',
  team_code: 'MUN',
  owner_name: 'Team Owner',
  initial_balance: 25000000,
  season_id: 'seasonDocId',
  logo: 'base64image...',
  team_color: '#FF0000',
});

// Result: Team with ID team0001 created
// Initialized with empty arrays and zero stats
```

### Updating Player Stats

```typescript
import { updateRealPlayerStats } from '@/lib/firebase/realPlayers';

await updateRealPlayerStats('sspslpsl0001', {
  matches_played: 1,  // Increment
  matches_won: 1,
  goals_scored: 2,
  assists: 1,
});

// win_rate automatically calculated
```

```typescript
import { updateFootballPlayerStats } from '@/lib/firebase/footballPlayers';

await updateFootballPlayerStats('footballPlayerDocId', {
  matches_played: 1,
  goals: 2,
  assists: 1,
  yellow_cards: 0,
});
```

### Updating Team Stats

```typescript
import { updateTeamStats } from '@/lib/firebase/teams';

await updateTeamStats('team0001', {
  matches_played: 1,
  matches_won: 1,
  goals_scored: 3,
  goals_conceded: 1,
  points: 3,
  clean_sheets: 0,
});

// goal_difference and win_rate automatically calculated
```

---

## Workflow Example

### Complete Team Setup & Match Flow

**1. Create Season**
```typescript
const season = await createSeason({ name: 'Season 2024', year: '2024' });
```

**2. Create Teams**
```typescript
const team1 = await createTeam({
  team_name: 'Manchester United',
  team_code: 'MUN',
  initial_balance: 25000000,
  season_id: season.id,
});
// Result: team0001 created
```

**3. Create RealPlayers (Committee Admins)**
```typescript
const player1 = await createRealPlayer({
  full_name: 'John Doe',
  team_id: 'team0001',
  season_id: season.id,
  role: 'captain',
});
// Result: sspslpsl0001 assigned to team0001
```

**4. Create FootballPlayers for Auction**
```typescript
const ronaldo = await createFootballPlayer({
  name: 'C. Ronaldo',
  primary_position: 'CF',
  attributes: { overall_rating: 91, ... },
  base_price: 5000000,
  season_id: season.id,
});
```

**5. Auction - Assign Players to Teams**
```typescript
await assignFootballPlayerToTeam({
  player_id: ronaldo.id,
  team_id: 'team0001',
  sold_price: 8500000,
  auction_round: 1,
});
// Team balance: 25M - 8.5M = 16.5M
// Team football_players array updated
```

**6. Play Matches - Update Stats**
```typescript
// Update RealPlayer stats
await updateRealPlayerStats('sspslpsl0001', {
  matches_played: 1,
  matches_won: 1,
  goals_scored: 2,
});

// Update FootballPlayer stats
await updateFootballPlayerStats(ronaldo.id, {
  matches_played: 1,
  goals: 2,
  assists: 1,
});

// Update Team stats
await updateTeamStats('team0001', {
  matches_played: 1,
  matches_won: 1,
  goals_scored: 3,
  goals_conceded: 1,
  points: 3,
});
```

---

## Firestore Indexes Required

Create these composite indexes in Firebase Console for optimal performance:

### RealPlayers Collection
1. **By Team and Season**
   - Collection: `realplayers`
   - Fields: `team_id` (Ascending), `season_id` (Ascending), `created_at` (Descending)

2. **By Season**
   - Collection: `realplayers`
   - Fields: `season_id` (Ascending), `created_at` (Descending)

### FootballPlayers Collection
1. **By Team and Season**
   - Collection: `footballplayers`
   - Fields: `team_id` (Ascending), `season_id` (Ascending)

2. **Available for Auction**
   - Collection: `footballplayers`
   - Fields: `season_id` (Ascending), `is_sold` (Ascending)

3. **By Position**
   - Collection: `footballplayers`
   - Fields: `season_id` (Ascending), `primary_position` (Ascending)

### Teams Collection
1. **By Season**
   - Collection: `teams`
   - Fields: `season_id` (Ascending), `created_at` (Descending)

---

## Security Rules

Recommended Firestore security rules:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // RealPlayers
    match /realplayers/{playerId} {
      // Super admins and committee admins can manage
      allow read, write: if request.auth != null && 
        (getUserRole() == 'super_admin' || getUserRole() == 'committee_admin');
      
      // Players can read their own profile
      allow read: if request.auth != null && 
        resource.data.player_id == request.auth.uid;
    }
    
    // FootballPlayers
    match /footballplayers/{playerId} {
      // Super admins and committee admins can manage
      allow read, write: if request.auth != null && 
        (getUserRole() == 'super_admin' || getUserRole() == 'committee_admin');
      
      // Teams can read players assigned to them
      allow read: if request.auth != null && getUserRole() == 'team';
    }
    
    // Teams
    match /teams/{teamId} {
      // Super admins can do anything
      allow read, write: if request.auth != null && getUserRole() == 'super_admin';
      
      // Committee admins can manage
      allow read, write: if request.auth != null && getUserRole() == 'committee_admin';
      
      // Team owners can read their own team
      allow read: if request.auth != null && 
        resource.data.owner_uid == request.auth.uid;
    }
  }
}
```

---

## Testing Checklist

- [ ] Create RealPlayer with custom ID generation (sspslpsl0001)
- [ ] Assign RealPlayer to team (team's real_players array updated)
- [ ] Create multiple RealPlayers (sequential IDs: 0002, 0003)
- [ ] Update RealPlayer stats (win_rate calculated)
- [ ] Create FootballPlayer
- [ ] Assign FootballPlayer to team via auction (balance deducted)
- [ ] Create team with custom ID (team0001)
- [ ] Update team stats (goal_difference calculated)
- [ ] Delete RealPlayer (removed from team)
- [ ] Delete FootballPlayer (removed from team)
- [ ] Get statistics for both player types

---

## Future Enhancements

- [ ] RealPlayer leaderboards by stats
- [ ] FootballPlayer market value tracking
- [ ] Player transfer system
- [ ] Match lineup builder (select 11 from 25 FootballPlayers)
- [ ] Player form tracking over time
- [ ] Injury system with recovery time
- [ ] Player chemistry/compatibility system
- [ ] Achievement badges for RealPlayers
- [ ] Player comparison tools
- [ ] Export/import player data (CSV/Excel)
- [ ] Player performance analytics dashboard
- [ ] Team formation builder with player positions
